<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>shell.c</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">// This is a personal academic project. Dear PVS-Studio, please check it.</a>
<a name="ln2">// PVS-Studio Static Code Analyzer for C, C++, C#, and Java: https://pvs-studio.com</a>
<a name="ln3"> </a>
<a name="ln4">#include &quot;../include/shell.h&quot;</a>
<a name="ln5"> </a>
<a name="ln6">// Buffer para el comando actual y el anterior</a>
<a name="ln7">static char current_input[INPUT_MAX];</a>
<a name="ln8">static char previous_input[INPUT_MAX];</a>
<a name="ln9">static char initial_input[INPUT_MAX];</a>
<a name="ln10">static void print_initial_message();</a>
<a name="ln11"> </a>
<a name="ln12">int main(void) {</a>
<a name="ln13">    sys_enable_textmode();</a>
<a name="ln14">    </a>
<a name="ln15">    // Limpiar buffer de teclado y resetear sem치foro antes de empezar</a>
<a name="ln16">    sys_clear_input_buffer();</a>
<a name="ln17"> </a>
<a name="ln18">    print_initial_message();</a>
<a name="ln19"> </a>
<a name="ln20">    // Limpiar buffer de teclado y resetear sem치foro antes de empezar</a>
<a name="ln21">    sys_clear_input_buffer();</a>
<a name="ln22"> </a>
<a name="ln23">    while (1) {</a>
<a name="ln24">        fprint(STDCYAN, initial_input);</a>
<a name="ln25">        print(PROMPT);</a>
<a name="ln26">        read_line(current_input, INPUT_MAX-1);</a>
<a name="ln27">        putchar('\n');</a>
<a name="ln28">        process_line(current_input);</a>
<a name="ln29">        // Guardar comando actual como anterior para pr칩xima iteraci칩n</a>
<a name="ln30">        for (int i = 0; i &lt; INPUT_MAX; i++) {</a>
<a name="ln31">            previous_input[i] = current_input[i];</a>
<a name="ln32">            if (current_input[i] == '\0') break;</a>
<a name="ln33">        }</a>
<a name="ln34">    }</a>
<a name="ln35">}</a>
<a name="ln36"> </a>
<a name="ln37"> </a>
<a name="ln38">/*-- FUNCIONES AUXILIARES --*/</a>
<a name="ln39">static void print_initial_message(){</a>
<a name="ln40">    sys_increase_fontsize();</a>
<a name="ln41">    fprint(STDMAGENTA, INITIAL_MESSAGE_1);</a>
<a name="ln42">    putchar('\n');</a>
<a name="ln43">    print(INITIAL_MESSAGE_2);</a>
<a name="ln44">    read_line(initial_input, USERNAME_MAX_LENGTH);</a>
<a name="ln45">    putchar('\n');</a>
<a name="ln46">    fprint(STDMAGENTA, HELP_MESSAGE);</a>
<a name="ln47">    putchar('\n');</a>
<a name="ln48">    sys_decrease_fontsize();</a>
<a name="ln49">}</a>
<a name="ln50"> </a>
<a name="ln51">void read_line(char * buf, uint64_t max) {</a>
<a name="ln52">    char c;</a>
<a name="ln53">    uint32_t idx = 0;</a>
<a name="ln54">    </a>
<a name="ln55">    // Limpiar el buffer al inicio</a>
<a name="ln56">    for (int i = 0; i &lt;= max; i++) {</a>
<a name="ln57">        buf[i] = '\0';</a>
<a name="ln58">    }</a>
<a name="ln59">    </a>
<a name="ln60">    // Mostrar cursor inicial</a>
<a name="ln61">    putchar(CURSOR);</a>
<a name="ln62"> </a>
<a name="ln63">    while((c = getchar()) != '\n') {</a>
<a name="ln64">        if (c == '+') {</a>
<a name="ln65">            incfont();</a>
<a name="ln66">        } else if(c == '-') {</a>
<a name="ln67">            decfont();</a>
<a name="ln68">        } else if (c == '\b') { // Backspace</a>
<a name="ln69">            if (idx != 0) {</a>
<a name="ln70">                idx--;</a>
<a name="ln71">                buf[idx] = '\0'; // Limpiar el caracter borrado</a>
<a name="ln72">                putchar('\b'); // borro el cursor</a>
<a name="ln73">                putchar('\b'); // borro el caracter</a>
<a name="ln74">                putchar(CURSOR);</a>
<a name="ln75">            }</a>
<a name="ln76">        } else if (idx &lt; max) {</a>
<a name="ln77">            buf[idx++] = c;</a>
<a name="ln78">            putchar('\b'); // borro el cursor</a>
<a name="ln79">            putchar(c);    // escribo el caracter</a>
<a name="ln80">            putchar(CURSOR); // escribo el cursor</a>
<a name="ln81">        }</a>
<a name="ln82">    }</a>
<a name="ln83"> </a>
<a name="ln84">    putchar('\b'); // borro el cursor final antes de salir</a>
<a name="ln85">    buf[idx] = 0;</a>
<a name="ln86">}</a>
<a name="ln87"> </a>
<a name="ln88"> </a>
<a name="ln89">void incfont()  { </a>
<a name="ln90">    sys_increase_fontsize(); </a>
<a name="ln91">    sys_clear();</a>
<a name="ln92">    // Imprimir prompt sin cursor (usar print directamente)</a>
<a name="ln93">    fprint(STDCYAN, initial_input);</a>
<a name="ln94">    print(PROMPT);</a>
<a name="ln95">    // Imprimir el input actual</a>
<a name="ln96">    for (int i = 0; current_input[i] != '\0' &amp;&amp; i &lt; INPUT_MAX; i++) {</a>
<a name="ln97">        putchar(current_input[i]);</a>
<a name="ln98">    }</a>
<a name="ln99">    // Un solo cursor al final</a>
<a name="ln100">    putchar(CURSOR);</a>
<a name="ln101">}</a>
<a name="ln102"> </a>
<a name="ln103">void decfont()  { </a>
<a name="ln104">    sys_decrease_fontsize(); </a>
<a name="ln105">    sys_clear();</a>
<a name="ln106">    // Imprimir prompt sin cursor (usar print directamente)</a>
<a name="ln107">    fprint(STDCYAN, initial_input);</a>
<a name="ln108">    print(PROMPT);</a>
<a name="ln109">    // Imprimir el input actual</a>
<a name="ln110">    for (int i = 0; current_input[i] != '\0' &amp;&amp; i &lt; INPUT_MAX; i++) {</a>
<a name="ln111">        putchar(current_input[i]);</a>
<a name="ln112">    }</a>
<a name="ln113">    // Un solo cursor al final</a>
<a name="ln114">    putchar(CURSOR);</a>
<a name="ln115">}</a>
<a name="ln116"> </a>
</code></pre>
<div class="balloon" rel="96"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v781/" target="_blank">V781</a> The value of the 'i' index is checked after it was used. Perhaps there is a mistake in program logic.</p></div>
<div class="balloon" rel="110"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v781/" target="_blank">V781</a> The value of the 'i' index is checked after it was used. Perhaps there is a mistake in program logic.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>